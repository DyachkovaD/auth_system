# Система управления доступом (RBAC)

## Обзор архитектуры

Система реализует ролевую модель управления доступом (Role-Based Access Control) с расширенными возможностями разграничения прав на уровне отдельных операций и объектов.

## Основные компоненты

### 1. Модель пользователя (User)
- **Email** - уникальный идентификатор пользователя
- **Имя/Фамилия** - персональные данные
- **is_active** - статус активности (мягкое удаление)
- **deleted_at** - дата деактивации аккаунта

### 2. Роли (Role)
```python
class Role(models.Model):
    name = CharField(unique=True)        # Название роли: 'admin', 'manager', 'user'
    description = TextField()            # Описание роли
```

### 3. Бизнес-элементы (BusinessElement)
```python
class BusinessElement(models.Model):
    name = CharField(unique=True)        # Имя элемента: 'products', 'orders', 'users'
    description = TextField()            # Описание элемента
```

### 4. Правила доступа (AccessRule)
```python
class AccessRule(models.Model):
    role = ForeignKey(Role)              # Ссылка на роль
    element = ForeignKey(BusinessElement) # Ссылка на бизнес-элемент
    
    # Права доступа (BooleanField):
    read_permission       # Чтение собственных объектов
    read_all_permission   # Чтение всех объектов
    create_permission     # Создание объектов
    update_permission     # Обновление собственных объектов
    update_all_permission # Обновление всех объектов
    delete_permission     # Удаление собственных объектов
    delete_all_permission # Удаление всех объектов
```

### 5. Связь пользователей с ролями (UserRole)
```python
class UserRole(models.Model):
    user = ForeignKey(User)              # Пользователь
    role = ForeignKey(Role)              # Роль пользователя
```

## Принцип работы

### Аутентификация
1. Пользователь логинится по email/password
2. Система генерирует JWT токен с user_id
3. Токен сохраняется в таблице сессий (Session)
4. При каждом запросе токен проверяется через middleware

### Авторизация
1. Получение пользователя из JWT токена
2. Определение ролей пользователя через UserRole
3. Проверка прав доступа через AccessRule
4. Применение правил к запрашиваемому ресурсу

## Иерархия прав доступа

### Уровень 1: Базовые права
- **read_permission** - просмотр собственных данных
- **create_permission** - создание новых объектов
- **update_permission** - изменение собственных объектов
- **delete_permission** - удаление собственных объектов

### Уровень 2: Расширенные права
- **read_all_permission** - просмотр всех объектов системы
- **update_all_permission** - изменение любых объектов
- **delete_all_permission** - удаление любых объектов

## Примеры ролей

### Администратор (admin)
```python
{
    "products": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True, "delete_all": True},
    "users": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True, "delete_all": True},
    "orders": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True, "delete_all": True},
    "access_rules": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True, "delete_all": True}
}
```

### Менеджер (manager)
```python
{
    "products": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True},
    "orders": {"read": True, "read_all": True, "create": True, "update": True, "update_all": True, "delete": True},
    "users": {"read": True, "read_all": True}
}
```

### Пользователь (user)
```python
{
    "products": {"read": True, "create": True},
    "orders": {"read": True, "create": True, "update": True, "delete": True}
}
```

## Бизнес-элементы системы

| Элемент | Описание | Примеры операций |
|---------|----------|------------------|
| `products` | Управление товарами | Просмотр каталога, добавление товаров |
| `orders` | Управление заказами | Создание заказов, отслеживание статусов |
| `users` | Управление пользователями | Регистрация, редактирование профилей |
| `access_rules` | Управление правами | Настройка ролей и разрешений |
| `dashboard` | Панель управления | Просмотр статистики, отчетов |
| `categories` | Управление категориями | Создание/редактирование категорий товаров |
| `reports` | Отчеты и аналитика | Генерация отчетов, анализ данных |

## Механизм проверки прав

### Алгоритм check_permission()
```python
def check_permission(user, element_name, action):
    # 1. Получение всех ролей пользователя
    # 2. Поиск бизнес-элемента по имени
    # 3. Проверка правил доступа для каждой роли
    # 4. Возврат True если хотя бы одна роль имеет право
```

### Примеры действий (action)
- `read` - чтение объекта
- `read_all` - чтение всех объектов
- `create` - создание объекта
- `update` - обновление объекта
- `update_all` - обновление всех объектов
- `delete` - удаление объекта
- `delete_all` - удаление всех объектов

## Обработка ошибок

### Коды ответов HTTP
- **200 OK** - успешный запрос с валидными правами
- **401 Unauthorized** - неверный/отсутствующий токен аутентификации
- **403 Forbidden** - действительный токен, но недостаточно прав
- **404 Not Found** - ресурс не существует или скрыт по правам доступа

### Сообщения об ошибках
```json
{
    "error": "Не авторизован",
    "detail": "Требуется действительный JWT токен"
}
```

```json
{
    "error": "Доступ запрещен",
    "detail": "Недостаточно прав для выполнения операции"
}
```

## API для управления доступом

### Только для администраторов
- `GET /api/admin/roles/` - список всех ролей
- `POST /api/admin/roles/` - создание новой роли
- `GET /api/admin/access-rules/` - список правил доступа
- `POST /api/admin/access-rules/` - создание правила доступа
- `PUT /api/admin/user-roles/` - назначение ролей пользователям

## Безопасность

### Хранение паролей
- Пароли хэшируются с использованием bcrypt
- Соль генерируется автоматически для каждого пользователя

### Токены аутентификации
- JWT токены с сроком действия 24 часа
- Хранение активных сессий в базе данных
- Возможность принудительного завершения сессий

### Защита от несанкционированного доступа
- Валидация токенов на каждом запросе
- Проверка прав доступа перед выполнением операций
- Логирование попыток доступа к защищенным ресурсам

## Расширяемость системы

### Добавление новых бизнес-элементов
1. Добавить запись в BusinessElement
2. Настроить правила доступа для ролей
3. Реализовать проверку прав в соответствующих view

### Создание кастомных ролей
1. Добавить новую роль в Role
2. Настроить AccessRule для нужных элементов
3. Назначить роль пользователям через UserRole

### Кастомные уровни доступа
Система позволяет легко добавлять новые типы разрешений через добавление полей в модель AccessRule.

## Миграция данных

### Начальное заполнение
Система включает скрипт для создания тестовых данных:
- Роли: admin, manager, user
- Бизнес-элементы: products, orders, users, etc.
- Пользователи с разными уровнями доступа
- Набор правил доступа

### Команда для инициализации
```bash
python create_test_data.py
```

Эта архитектура обеспечивает гибкое и безопасное управление доступом с возможностью тонкой настройки прав для различных категорий пользователей.